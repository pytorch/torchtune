


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchtune.models.llama4._tokenizer &mdash; torchtune main documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom_torchtune.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/edge">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News 
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/videos">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/credits">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tac">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/staff">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contact-us">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://pytorch.org/join" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
        <a href='https://pytorch.org/torchtune/versions.html'>main &#x25BC</a>
      </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">torchtune Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Install Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/first_finetune_tutorial.html">Fine-Tune Your First LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tune_cli.html">torchtune CLI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finetuning Recipes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../recipes/recipes_overview.html">Recipes Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../recipes/lora_finetune_single_device.html">LoRA Single Device Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../recipes/qat_distributed.html">Distributed Quantization-Aware Training (QAT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../recipes/dpo.html">Direct Preference Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/datasets_overview.html">Datasets Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/chat_datasets.html">Chat Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/instruct_datasets.html">Instruct Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/multimodal_datasets.html">Multimodal Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/preference_datasets.html">Preference Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/text_completion_datasets.html">Text-completion Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/model_transforms.html">Multimodal Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/messages.html">Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/message_transforms.html">Message Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/tokenizers.html">Tokenizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/prompt_templates.html">Prompt Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/packing.html">Sample packing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics/custom_components.html">Custom Components and Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/llama3.html">Meta Llama3 in torchtune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/chat.html">Fine-Tuning Llama3 with Chat Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/lora_finetune.html">Fine-Tuning Llama2 with LoRA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/qlora_finetune.html">Fine-Tuning Llama2 with QLoRA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/qat_finetune.html">Fine-Tuning Llama3 with QAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/e2e_flow.html">End-to-End Workflow with torchtune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/llama_kd_tutorial.html">Distilling Llama3.1 8B into Llama3.2 1B using Knowledge Distillation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/memory_optimizations.html">Memory Optimization Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/multinode.html">Multi-node finetuning</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep-Dives</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../deep_dives/checkpointer.html">Checkpointing in torchtune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deep_dives/configs.html">All About Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deep_dives/recipe_deepdive.html">What Are Recipes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deep_dives/comet_logging.html">Logging to Comet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deep_dives/wandb_logging.html">Logging to Weights &amp; Biases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_config.html">torchtune.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_data.html">torchtune.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_datasets.html">torchtune.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_generation.html">torchtune.generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_models.html">torchtune.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_modules.html">torchtune.modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_rlhf.html">torchtune.rlhf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_training.html">torchtune.training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_ref_utilities.html">torchtune.utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>torchtune.models.llama4._tokenizer</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torchtune.models.llama4._tokenizer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the BSD-style license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchtune.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">PromptTemplateInterface</span><span class="p">,</span> <span class="n">truncate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchtune.modules.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchtune.modules.transforms.tokenizers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ModelTokenizer</span><span class="p">,</span>
    <span class="n">TikTokenBaseTokenizer</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">O200K_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;[^\r\n\p</span><span class="si">{L}</span><span class="s2">\p</span><span class="si">{N}</span><span class="s2">]?[\p</span><span class="si">{Lu}</span><span class="s2">\p</span><span class="si">{Lt}</span><span class="s2">\p</span><span class="si">{Lm}</span><span class="s2">\p</span><span class="si">{Lo}</span><span class="s2">\p</span><span class="si">{M}</span><span class="s2">]*[\p</span><span class="si">{Ll}</span><span class="s2">\p</span><span class="si">{Lm}</span><span class="s2">\p</span><span class="si">{Lo}</span><span class="s2">\p</span><span class="si">{M}</span><span class="s2">]+(?i:&#39;s|&#39;t|&#39;re|&#39;ve|&#39;m|&#39;ll|&#39;d)?|[^\r\n\p</span><span class="si">{L}</span><span class="s2">\p</span><span class="si">{N}</span><span class="s2">]?[\p</span><span class="si">{Lu}</span><span class="s2">\p</span><span class="si">{Lt}</span><span class="s2">\p</span><span class="si">{Lm}</span><span class="s2">\p</span><span class="si">{Lo}</span><span class="s2">\p</span><span class="si">{M}</span><span class="s2">]+[\p</span><span class="si">{Ll}</span><span class="s2">\p</span><span class="si">{Lm}</span><span class="s2">\p</span><span class="si">{Lo}</span><span class="s2">\p</span><span class="si">{M}</span><span class="s2">]*(?i:&#39;s|&#39;t|&#39;re|&#39;ve|&#39;m|&#39;ll|&#39;d)?|\p</span><span class="si">{N}</span><span class="s2">{1,3}| ?[^\s\p</span><span class="si">{L}</span><span class="s2">\p</span><span class="si">{N}</span><span class="s2">]+[\r\n/]*|\s*[\r\n]+|\s+(?!\S)|\s+&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_reserved_special_tokens</span><span class="p">(</span><span class="n">start_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_reserved</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_reserved_special_token&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;reserved_special_token&quot;</span>
    <span class="n">reserved_tokens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">)):</span>
        <span class="n">reserved_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&lt;|</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">start_reserved</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="si">}</span><span class="s2">|&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="k">return</span> <span class="n">reserved_tokens</span>


<span class="c1"># 200000, ..., 200004</span>
<span class="n">BASIC_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;|begin_of_text|&gt;&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|end_of_text|&gt;&quot;</span><span class="p">:</span> <span class="mi">200001</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|fim_prefix|&gt;&quot;</span><span class="p">:</span> <span class="mi">200002</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|fim_middle|&gt;&quot;</span><span class="p">:</span> <span class="mi">200003</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|fim_suffix|&gt;&quot;</span><span class="p">:</span> <span class="mi">200004</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># 200005, ..., 200079</span>
<span class="n">TEXT_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;|header_start|&gt;&quot;</span><span class="p">:</span> <span class="mi">200005</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|header_end|&gt;&quot;</span><span class="p">:</span> <span class="mi">200006</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|eom|&gt;&quot;</span><span class="p">:</span> <span class="mi">200007</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|eot|&gt;&quot;</span><span class="p">:</span> <span class="mi">200008</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|step|&gt;&quot;</span><span class="p">:</span> <span class="mi">200009</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_0|&gt;&quot;</span><span class="p">:</span> <span class="mi">200010</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_1|&gt;&quot;</span><span class="p">:</span> <span class="mi">200011</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_2|&gt;&quot;</span><span class="p">:</span> <span class="mi">200012</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_3|&gt;&quot;</span><span class="p">:</span> <span class="mi">200013</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_4|&gt;&quot;</span><span class="p">:</span> <span class="mi">200014</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_5|&gt;&quot;</span><span class="p">:</span> <span class="mi">200015</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_6|&gt;&quot;</span><span class="p">:</span> <span class="mi">200016</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|text_post_train_reserved_special_token_7|&gt;&quot;</span><span class="p">:</span> <span class="mi">200017</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|finetune_right_pad|&gt;&quot;</span><span class="p">:</span> <span class="mi">200018</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">get_reserved_special_tokens</span><span class="p">(</span><span class="mi">200019</span><span class="p">,</span> <span class="mi">200080</span><span class="p">,</span> <span class="s2">&quot;text_post_train&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="c1"># 200080, ..., 201133</span>
<span class="n">VISION_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;|image_start|&gt;&quot;</span><span class="p">:</span> <span class="mi">200080</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|image_end|&gt;&quot;</span><span class="p">:</span> <span class="mi">200081</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_0|&gt;&quot;</span><span class="p">:</span> <span class="mi">200082</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_1|&gt;&quot;</span><span class="p">:</span> <span class="mi">200083</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|tile_x_separator|&gt;&quot;</span><span class="p">:</span> <span class="mi">200084</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|tile_y_separator|&gt;&quot;</span><span class="p">:</span> <span class="mi">200085</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_2|&gt;&quot;</span><span class="p">:</span> <span class="mi">200086</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_3|&gt;&quot;</span><span class="p">:</span> <span class="mi">200087</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_4|&gt;&quot;</span><span class="p">:</span> <span class="mi">200088</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_5|&gt;&quot;</span><span class="p">:</span> <span class="mi">200089</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|image|&gt;&quot;</span><span class="p">:</span> <span class="mi">200090</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|vision_reserved_special_token_6|&gt;&quot;</span><span class="p">:</span> <span class="mi">200091</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|patch|&gt;&quot;</span><span class="p">:</span> <span class="mi">200092</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">get_reserved_special_tokens</span><span class="p">(</span><span class="mi">200093</span><span class="p">,</span> <span class="mi">201134</span><span class="p">,</span> <span class="s2">&quot;vision&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># 201134, ..., 201143</span>
<span class="n">REASONING_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_0|&gt;&quot;</span><span class="p">:</span> <span class="mi">201134</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_1|&gt;&quot;</span><span class="p">:</span> <span class="mi">201135</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_2|&gt;&quot;</span><span class="p">:</span> <span class="mi">201136</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_3|&gt;&quot;</span><span class="p">:</span> <span class="mi">201137</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_4|&gt;&quot;</span><span class="p">:</span> <span class="mi">201138</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_5|&gt;&quot;</span><span class="p">:</span> <span class="mi">201139</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_6|&gt;&quot;</span><span class="p">:</span> <span class="mi">201140</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_reserved_special_token_7|&gt;&quot;</span><span class="p">:</span> <span class="mi">201141</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_thinking_start|&gt;&quot;</span><span class="p">:</span> <span class="mi">201142</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|reasoning_thinking_end|&gt;&quot;</span><span class="p">:</span> <span class="mi">201143</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">BASIC_SPECIAL_TOKENS</span>
    <span class="o">|</span> <span class="n">TEXT_SPECIAL_TOKENS</span>
    <span class="o">|</span> <span class="n">VISION_SPECIAL_TOKENS</span>
    <span class="o">|</span> <span class="n">REASONING_SPECIAL_TOKENS</span>
<span class="p">)</span>

<span class="n">NUM_RESERVED_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="mi">2048</span>

<span class="n">RESERVED_TOKENS</span> <span class="o">=</span> <span class="n">get_reserved_special_tokens</span><span class="p">(</span><span class="mi">201144</span><span class="p">,</span> <span class="mi">202048</span><span class="p">)</span>

<span class="n">LLAMA4_SPECIAL_TOKENS</span> <span class="o">=</span> <span class="n">SPECIAL_TOKENS</span> <span class="o">|</span> <span class="n">RESERVED_TOKENS</span>


<div class="viewcode-block" id="Llama4Tokenizer"><a class="viewcode-back" href="../../../../generated/torchtune.models.llama4.Llama4Tokenizer.html#torchtune.models.llama4.Llama4Tokenizer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Llama4Tokenizer</span><span class="p">(</span><span class="n">ModelTokenizer</span><span class="p">,</span> <span class="n">Transform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tiktoken tokenizer configured with Llama4 Instruct&#39;s special tokens, as described in</span>
<span class="sd">    https://www.llama.com/docs/model-cards-and-prompt-formats/llama4_omni/</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to pretrained tiktoken tokenizer file.</span>
<span class="sd">        special_tokens (Optional[dict[str, int]]): mapping containing special text tokens and</span>
<span class="sd">            their registered token IDs. If left as None, this will be set to the canonical</span>
<span class="sd">            Llama4 special tokens.</span>
<span class="sd">        max_seq_len (Optional[int]): maximum sequence length for tokenizing a single list of messages,</span>
<span class="sd">            after which the input will be truncated. Default is None.</span>
<span class="sd">        prompt_template (Optional[PromptTemplateInterface]): template used to format the messages based on their role. This is used</span>
<span class="sd">            to add structured text around the actual messages. The structured text is used in three scenarios:</span>

<span class="sd">            - Task-specific templates to gear models for a particular task that it will expect after training</span>
<span class="sd">            - Model-specific templates that are required whenever the model is prompted, such as the [INST]</span>
<span class="sd">              tags in Llama2 and in Mistral</span>
<span class="sd">            - Community standardized templates, such as :class:`~torchtune.data.ChatMLTemplate`</span>
<span class="sd">        truncation_type (str): type of truncation to apply, either &quot;left&quot; or &quot;right&quot;.</span>
<span class="sd">            Default is &quot;right&quot;.</span>

<span class="sd">            The extra text will still get tokenized as normal text, not as special tokens. Default is None.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; tokenizer = Llama4Tokenizer(&quot;/path/to/tt_model&quot;)</span>
<span class="sd">        &gt;&gt;&gt; tokenized_text = tokenizer.encode(&quot;Hello world!&quot;, add_bos=True, add_eos=True)</span>
<span class="sd">        &gt;&gt;&gt; print(tokenized_text)</span>
<span class="sd">        [1, 31587, 29644, 102, 2]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">special_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptTemplateInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">truncation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">special_tokens</span> <span class="k">if</span> <span class="n">special_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">LLAMA4_SPECIAL_TOKENS</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_special_tokens</span><span class="p">()</span>

        <span class="c1"># Encode BOS and EOS, define pad_id and step_od</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|begin_of_text|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|end_of_text|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|finetune_right_pad|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|step|&gt;&quot;</span><span class="p">]</span>

        <span class="c1"># Encode extra special tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_header_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|header_start|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_header_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|header_end|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eom_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|eom|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|eot|&gt;&quot;</span><span class="p">]</span>

        <span class="c1"># Image tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|image|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|patch|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|image_start|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|image_end|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|tile_x_separator|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|tile_y_separator|&gt;&quot;</span><span class="p">]</span>

        <span class="c1"># Reasoning tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|reasoning_thinking_start|&gt;&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">[</span><span class="s2">&quot;&lt;|reasoning_thinking_end|&gt;&quot;</span><span class="p">]</span>

        <span class="c1"># During generation, stop when either eos_id, eot_id, or eom_id is encountered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eot_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eom_id</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tt_model</span> <span class="o">=</span> <span class="n">TikTokenBaseTokenizer</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;llama4_tiktoken&quot;</span><span class="p">,</span>
            <span class="n">pattern</span><span class="o">=</span><span class="n">O200K_PATTERN</span><span class="p">,</span>
            <span class="n">bos_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span><span class="p">,</span>
            <span class="n">eos_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">,</span>
            <span class="n">special_tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span>

        <span class="c1"># Regex for removing special tokens from the decoded string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_special_token_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;\|.*?\|&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_special_token_header_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;&lt;\|header_start\|&gt;.*?&lt;\|header_end\|&gt;\n\n&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">truncation_type</span> <span class="o">=</span> <span class="n">truncation_type</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_special_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that required special tokens are passed into the tokenizer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">SPECIAL_TOKENS</span><span class="p">:</span>
            <span class="n">reserve_token</span> <span class="o">=</span> <span class="s2">&quot;_reserved_special_token_&quot;</span> <span class="ow">in</span> <span class="n">token</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reserve_token</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> missing from special_tokens&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove special tokens from the decoded string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First remove the headers, then the remaining special tokens</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_token_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_token_header_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_model</span><span class="o">.</span><span class="n">base_vocab_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_model</span><span class="o">.</span><span class="n">vocab_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">add_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">add_eos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">add_bos</span><span class="o">=</span><span class="n">add_bos</span><span class="p">,</span> <span class="n">add_eos</span><span class="o">=</span><span class="n">add_eos</span><span class="p">)</span>

<div class="viewcode-block" id="Llama4Tokenizer.decode"><a class="viewcode-back" href="../../../../generated/torchtune.models.llama4.Llama4Tokenizer.html#torchtune.models.llama4.Llama4Tokenizer.decode">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">token_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">truncate_at_eos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_special_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decode a list of token ids into a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_ids (list[int]): The list of token ids.</span>
<span class="sd">            truncate_at_eos (bool): Whether to truncate the string at the end of</span>
<span class="sd">                sequence token. Default is True.</span>
<span class="sd">            skip_special_tokens (bool): Whether to show or skip special tokens in the decoded string.</span>
<span class="sd">                Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The decoded string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We will remove special tokens manually via regex on the decoded string.</span>
        <span class="c1"># This is because removing all special tokens does not remove the role and</span>
        <span class="c1"># whitespace added from the special tokens, i.e., the &quot;user&quot; and &quot;\n\n&quot; in</span>
        <span class="c1"># &quot;&lt;|start_header_id|&gt;user&lt;|end_header_id|&gt;\n\n&quot;</span>
        <span class="n">decoded_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">,</span>
            <span class="n">truncate_at_eos</span><span class="o">=</span><span class="n">truncate_at_eos</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_special_tokens</span><span class="p">(</span><span class="n">decoded_string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_special_tokens</span>
            <span class="k">else</span> <span class="n">decoded_string</span>
        <span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tile_grid_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">patch_tokens_per_tile</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">aspect_ratio</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the number of patches per tile, the number of tiles, and the aspect ratio of the image,</span>
<span class="sd">        construct the tokenized tile grid with patch and tile separator tokens.</span>

<span class="sd">        Ex: For an image with aspect ratio 2x3, N patches per tile, and a global thumbnail,</span>
<span class="sd">        the tokenized tile grid will be:</span>

<span class="sd">            &lt;|image_start|&gt;</span>
<span class="sd">            &lt;|patch|&gt;*N&lt;|tile_x_separator|&gt;&lt;|patch|&gt;*N&lt;|tile_x_separator|&gt;&lt;|patch|&gt;*N&lt;|tile_y_separator|&gt;</span>
<span class="sd">            &lt;|patch|&gt;*N&lt;|tile_x_separator|&gt;&lt;|patch|&gt;*N&lt;|tile_x_separator|&gt;&lt;|patch|&gt;*N&lt;|tile_y_separator|&gt;</span>
<span class="sd">            &lt;|image|&gt;&lt;|patch|&gt;*N</span>
<span class="sd">            &lt;|image_end|&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_start</span><span class="p">)</span>
        <span class="n">single_tile_tokens</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">patch_tokens_per_tile</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_end</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">single_tile_ar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">)</span>
        <span class="c1"># If the image is a single tile, AR is 1x1 and we don&#39;t need to add the tile separator tokens</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">,</span> <span class="n">single_tile_ar</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">single_tile_tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add a grid of patch ids separated by tile separator tokens</span>
            <span class="c1"># x separator denotes a boundary between two horizontal patches</span>
            <span class="c1"># y separator denotes end of a row and start of a new row</span>
            <span class="n">ratio_h</span><span class="p">,</span> <span class="n">ratio_w</span> <span class="o">=</span> <span class="n">aspect_ratio</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ratio_h</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ratio_w</span><span class="p">):</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">patch_tokens_per_tile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">ratio_w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x_separator</span><span class="p">)</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_y_separator</span><span class="p">)</span>
            <span class="c1"># Add tokens for the global thumbnail, appended after the grid</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">single_tile_tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tokenize_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tokenize header start, message role, and header end as list of ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_header_id</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">add_bos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_eos</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_header_id</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">add_bos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_eos</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tokenize_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add eot or eom id at the end of the message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eot_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">eot</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eom_id</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tokenize_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tokenize message content as list of ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenized_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">tokenized_body</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">add_bos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_eos</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="n">patch_tokens_per_tile</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patch_tokens_per_tile&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aspect_ratio&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">tokenized_body</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tile_grid_tokens</span><span class="p">(</span>
                    <span class="n">patch_tokens_per_tile</span><span class="p">,</span> <span class="n">aspect_ratio</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">tokenized_body</span>

<div class="viewcode-block" id="Llama4Tokenizer.tokenize_message"><a class="viewcode-back" href="../../../../generated/torchtune.models.llama4.Llama4Tokenizer.html#torchtune.models.llama4.Llama4Tokenizer.tokenize_message">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">add_start_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">add_end_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tokenize a message into a list of token ids.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (Message): The message to tokenize.</span>
<span class="sd">            add_start_tokens (bool): Whether to prepend a tokenized header to the message. Default is True.</span>
<span class="sd">            add_end_tokens (bool): Whether to append eot or eom id at the end of the message. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: The list of token ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenized_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize_header</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_start_tokens</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">tokenized_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize_body</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">tokenized_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize_end</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_end_tokens</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">tokenized_message</span> <span class="o">=</span> <span class="n">tokenized_header</span> <span class="o">+</span> <span class="n">tokenized_body</span> <span class="o">+</span> <span class="n">tokenized_end</span>
        <span class="k">return</span> <span class="n">tokenized_message</span></div>

<div class="viewcode-block" id="Llama4Tokenizer.tokenize_messages"><a class="viewcode-back" href="../../../../generated/torchtune.models.llama4.Llama4Tokenizer.html#torchtune.models.llama4.Llama4Tokenizer.tokenize_messages">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_messages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">add_end_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tokenize a list of messages into a list of token ids and masks.</span>

<span class="sd">        Args:</span>
<span class="sd">            messages (list[Message]): The list of messages to tokenize.</span>
<span class="sd">            add_end_tokens (bool): Whether to append end tokens ids (end-of-seq, end-of-turn, end-of-message) at the end of the</span>
<span class="sd">                last assistant message. This value should be set to False for generation. Default is True.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Tokenize a list of messages with default settings</span>
<span class="sd">            &gt;&gt;&gt; messages = [</span>
<span class="sd">            ...     Message(role=&quot;user&quot;, content=&quot;Hello world!&quot;, masked=True),</span>
<span class="sd">            ...     Message(role=&quot;assistant&quot;, content=&quot;How are you?&quot;, masked=False),</span>
<span class="sd">            ... ]</span>
<span class="sd">            &gt;&gt;&gt; tokenizer = Llama3Tokenizer(&quot;/path/to/tt_model&quot;)</span>
<span class="sd">            &gt;&gt;&gt; tokenizer.tokenize_messages(messages)</span>
<span class="sd">            ([1, 31587, 29644, 102, 1, 31587, 29644, 102, 2], [True, True, True, True, True, False, False, False, True])</span>

<span class="sd">            &gt;&gt;&gt; # Tokenize a list of messages with add_end_tokens set to False</span>
<span class="sd">            &gt;&gt;&gt; tokenizer.tokenize_messages(messages, add_end_tokens=False)</span>
<span class="sd">            ([1, 31587, 29644, 102, 1, 31587, 29644], [True, True, True, True, True, False, False])</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[int], list[bool]]: The list of token ids and the list of masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">templated_messages</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">messages</span>
        <span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span><span class="p">]</span>
        <span class="c1"># bos and eos are always masked</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>

        <span class="n">num_messages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">templated_messages</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templated_messages</span><span class="p">):</span>
            <span class="c1"># Add end tokens to the last assistant message if add_end_tokens is True</span>
            <span class="c1"># Otherwise, end tokens should always be added</span>
            <span class="n">add_end_tokens_to_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">add_end_tokens</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_messages</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">tokenized_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_message</span><span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">add_end_tokens</span><span class="o">=</span><span class="n">add_end_tokens_to_message</span>
            <span class="p">)</span>

            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span> <span class="o">+</span> <span class="n">tokenized_message</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="p">([</span><span class="n">message</span><span class="o">.</span><span class="n">masked</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_message</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">add_end_tokens</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span>
                <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span>
                <span class="n">max_seq_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
                <span class="n">eos_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span> <span class="k">if</span> <span class="n">add_end_tokens</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">truncation_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span>
                <span class="n">tokens</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">max_seq_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
                <span class="n">eos_id</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">add_end_tokens</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">truncation_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_type</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">mask</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">inference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply ``tokenize_messages`` to the &quot;messages&quot; field in the sample.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample (Mapping[str, Any]): A sample with a &quot;messages&quot; field containing</span>
<span class="sd">                a list[Message] to tokenize</span>
<span class="sd">            inference (bool): Whether the template is being used for inference or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping[str, Any]: The sample with added &quot;tokens&quot; and &quot;mask&quot; fields</span>
<span class="sd">                and the &quot;messages&quot; field removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">add_end_tokens</span><span class="o">=</span><span class="ow">not</span> <span class="n">inference</span><span class="p">)</span>
        <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">return</span> <span class="n">sample</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023-present, torchtune Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/clipboard.min.js"></script>
         <script src="../../../../_static/copybutton.js"></script>
         <script src="../../../../_static/design-tabs.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<!-- Disabling "auto-collapsing" of sections on the left side bar. Replace script with commented out sections to reenable. -->
<!--  
<script script type="text/javascript">
    var collapsedSections = ['Introduction', 'Getting Started', 'Tutorials']
</script> -->

<script type="text/javascript">
    var collapsedSections = []
</script>
 
<script type="text/javascript">
    $(document).ready(function() {
        $(".main-menu-item a[href='https://github.com/pytorch/pytorch']").attr("href", "https://github.com/pytorch/torchtune");
    });
</script>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>Learn</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/get-started">Get Started</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials">Tutorials</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">Learn the Basics</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch Recipes</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/introyt.html">Introduction to PyTorch - YouTube Series</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>Ecosystem</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/ecosystem">Tools</a>
             </li>
             <li>
               <a href="https://pytorch.org/#community-module">Community</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">Forums</a>
             </li>
             <li>
               <a href="https://pytorch.org/resources">Developer Resources</a>
             </li>
             <li>
               <a href="https://pytorch.org/ecosystem/contributor-awards-2023">Contributor Awards - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Edge</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/edge">About PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://pytorch.org/executorch-overview">ExecuTorch</a>
             </li>
             <li>
               <a href="https://pytorch.org/executorch/stable/index.html">ExecuTorch Documentation</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Docs</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/pytorch-domains">PyTorch Domains</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>Blog & News</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/blog/">PyTorch Blog</a>
            </li>
            <li>
              <a href="https://pytorch.org/community-blog">Community Blog</a>
            </li>

            <li>
              <a href="https://pytorch.org/videos">Videos</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>
            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>
            <li>
               <a href="https://pytorch.org/newsletter">Newsletter</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>About</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>
            <li>
              <a href="https://pytorch.org/governing-board">Governing Board</a>
            </li>
            <li>
               <a href="https://pytorch.org/credits">Cloud Credit Program</a>
            </li>
            <li>
               <a href="https://pytorch.org/tac">Technical Advisory Council</a>
            </li>
            <li>
               <a href="https://pytorch.org/staff">Staff</a>
            </li>
            <li>
               <a href="https://pytorch.org/contact-us">Contact Us</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>